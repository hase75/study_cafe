<div class="container my-5">
  
  <div class="row">

    <div class="col-3 pr-5">
      <div "sidebar_fixed">
        <%= render 'public/spaces/searchform', q: @q, url: spaces_path %>
      </div>
    </div>

    <div class="col-9">
      <div class="row">
        <div class="col-3">
          <h3 class="border rounded shadow-sm font-weight-bold px-3 mb-4">全国の店舗</h3>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div id='map'></div>
          <style>
          #map {
            height: 500px;
            width: 100%;
          }
          </style>
          <script>
          let map

          function initMap(){
            geocoder = new google.maps.Geocoder()

            map = new google.maps.Map(document.getElementById('map'), {
              center: {lat: 36.2048240, lng:138.2529240},
              zoom: 5,
            });

            <% @spaces.each_with_index do |space, i| %>
              var latLng = {lat: <%= space.latitude %>, lng:<%= space.longitude %>}
              var marker<%= i %> = new google.maps.Marker({
                position:  latLng,
                map: map
              });

              var infoWindow<%= i %> = new google.maps.InfoWindow({
                position: latLng,
                content: `
                <div class="card" style="width: 14rem;">
                  <%=j image_tag "no_image.jpeg", class: "mx-5" %>
                  <div class="card-body">
                    <h5 class="card-title"><%=j space.name %></div>
                    <p class="card-text mx-2"><%=j space.introduction.truncate(24) %></p>
                    <%=j link_to "詳しくみる", space, data: {"turbolinks"=>false}, class: "btn btn-primary mx-2" %>
                  </div>
                </div>
                `
              });
              marker<%= i %>.addListener('click', () => {
                infoWindow<%= i %>.open(map, marker<%= i %>);
              });
            <% end %>
          }
          </script>
          <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvlf0tCGkpE21Wxbi80hNfYo1vdNw3TOc&callback=initMap" async defer></script>
        </div>
      </div>
      
      <div class="row">
        <div class="col-12">
          <div class="table">
            <table class="table table-bordered border-dark">
              <thead>
                <tr class="bg-secondary text-light">
                　<th></th>
                  <th>店名</th>
                  <th>ジャンル</th>
                  <th>評価</th>
                </tr>
              </thead>
              <tbody>
              <% @spaces.each do |space| %>
                <tr>
                  <td><%= image_tag space.get_image, size: '100x100' %></td>
                  <td><%= link_to space.name,space_path(space.id) %></td>
                  <td><%= space.genre.name %></td>
                  <td>
                    <%= space.average_rating %>
                    <div id="rating-rate<%= space.id %>"></div>
                      <script>
                        $('#rating-rate<%= space.id %>').raty({
                          size      : 36,
                          starOff   : '<%= asset_path('star-off.png') %>',
                          starOn    : '<%= asset_path('star-on.png') %>',
                          starHalf  : '<%= asset_path('star-half.png') %>',
                          readOnly: true,
                          score: <%= space.average_rating || 0 %>,
                          half: true
                        });
                      </script>
                  </td>
                </tr>
              <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>