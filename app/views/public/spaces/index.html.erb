<div class="container my-5">

  <div class="row">
    <h3 class="border rounded shadow-sm font-weight-bold px-3">店舗一覧</h3>
  </div>

  <div class="row mt-5">
    <table class="table table-bordered border-dark">
      <thead>
        <tr class="bg-secondary text-light">
        　<th></th>
          <th>店名</th>
          <th>ジャンル</th>
          <th>評価</th>
        </tr>
      </thead>
      <tbody>
      <% @spaces.each do |space| %>
        <tr>
          <td><%= image_tag space.get_image, size: '100x100' %></td>
          <td><%= link_to space.name,space_path(space.id) %></td>
          <td><%= space.genre.name %></td>
          <td>
            <%= space.average_rating %>
            <div id="rating-rate<%= space.id %>"></div>
              <script>
                $('#rating-rate<%= space.id %>').raty({
                  size      : 36,
                  starOff   : '<%= asset_path('star-off.png') %>',
                  starOn    : '<%= asset_path('star-on.png') %>',
                  starHalf  : '<%= asset_path('star-half.png') %>',
                  readOnly: true,
                  score: <%= space.average_rating || 0 %>,
                  half: true
                });
              </script>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>
</div>



<%= render 'public/spaces/searchform', q: @q, url: spaces_path %>




<h2>gmap</h2>

<input id="address" type="textbox" >
<input type="button" value="検索" onclick="codeAddress()">

<div id='map'></div>

<style>
#map {
  height: 600px;
  width: 600px;
}
</style>

<script>
let map

function initMap(){
  geocoder = new google.maps.Geocoder()

  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 35.6761919, lng:139.6503106},
    zoom: 10,
  });

  <% @spaces.each do |space| %>
    marker = new google.maps.Marker({
      position:  {lat: <%= space.latitude %>, lng:<%= space.longitude %>},
      map: map
    });
  <% end %>
  
     infoWindow = new google.maps.InfoWindow({
     content: '新宿駅'
    });
    infowindow.open(map, marker);
}

let geocoder

function codeAddress(){
  let inputAddress = document.getElementById('address').value;

  geocoder.geocode( { 'address': inputAddress}, function(results, status) {
    if (status == 'OK') {
      map.setCenter(results[0].geometry.location);
      var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
      });
    } else {
      alert('該当する結果がありませんでした：' + status);
    }
  });
}

// マーカーにクリックイベントを追加
    function markerEvent(i) {
        marker.addListener('click', function() {
            if(activeWindow !== undefined){
                activeWindow.close();
            }
            activeWindow = infoWindow;
            infoWindow[i].open(map, marker);
      });
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvlf0tCGkpE21Wxbi80hNfYo1vdNw3TOc&callback=initMap" async defer></script>