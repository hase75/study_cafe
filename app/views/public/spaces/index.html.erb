<div class="container my-5">

  <div class="row">
    <h3 class="border rounded shadow-sm font-weight-bold px-3">店舗一覧</h3>
  </div>

  <div class="row mt-5">
    <table class="table table-bordered border-dark">
      <thead>
        <tr class="bg-secondary text-light">
        　<th></th>
          <th>店名</th>
          <th>ジャンル</th>
          <th>評価</th>
        </tr>
      </thead>
      <tbody>
      <% @spaces.each do |space| %>
        <tr>
          <td><%= image_tag space.get_image, size: '100x100' %></td>
          <td><%= link_to space.name,space_path(space.id) %></td>
          <td><%= space.genre.name %></td>
          <td>
            <%= space.average_rating %>
            <div id="rating-rate<%= space.id %>"></div>
              <script>
                $('#rating-rate<%= space.id %>').raty({
                  size      : 36,
                  starOff   : '<%= asset_path('star-off.png') %>',
                  starOn    : '<%= asset_path('star-on.png') %>',
                  starHalf  : '<%= asset_path('star-half.png') %>',
                  readOnly: true,
                  score: <%= space.average_rating || 0 %>,
                  half: true
                });
              </script>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

  <%= render 'public/spaces/searchform', q: @q, url: spaces_path %>

  <h2>gmap</h2>

  <!--<div class="form-group">-->
  <!--  <input id="address" type="textbox", class="form-control d-inline w-50" >-->
  <!--  <input type="button" value="検索" onclick="codeAddress()", class="btn btn-primary d-inline ml-4 px-4">-->
  <!--</div>-->
  

<div id='map'></div>
</div>

<style>
#map {
  height: 300px;
  width: 100%;
}
</style>

<script>
let map

function initMap(){
  geocoder = new google.maps.Geocoder()

  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 35.6761919, lng:139.6503106},
    zoom: 10,
  });

  <% @spaces.each_with_index do |space, i| %>
    var latLng = {lat: <%= space.latitude %>, lng:<%= space.longitude %>}
    var marker<%= i %> = new google.maps.Marker({
      position:  latLng,
      map: map
    });

    var infoWindow<%= i %> = new google.maps.InfoWindow({
      position: latLng,
      content: `
      <div class="card" style="width: 14rem;">
        <%=j image_tag "no_image.jpeg", class: "mx-5" %>
        <div class="card-body">
          <h5 class="card-title"><%=j space.name %></div>
          <p class="card-text mx-2"><%=j space.introduction.truncate(24) %></p>
          <%=j link_to "詳しくみる", space, class: "btn btn-primary mx-2" %>
        </div>
      </div>
      `
    });
    marker<%= i %>.addListener('click', () => {
      infoWindow<%= i %>.open(map, marker<%= i %>);
    });
  <% end %>

}

let geocoder

function codeAddress(){
  let inputAddress = document.getElementById('address').value;

  geocoder.geocode( { 'address': inputAddress}, function(results, status) {
    if (status == 'OK') {
      map.setCenter(results[0].geometry.location);
      var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
      });
    } else {
      alert('該当する結果がありませんでした：' + status);
    }
  });
}

// マーカーにクリックイベントを追加
    function markerEvent(i) {
        marker.addListener('click', function() {
            if(activeWindow !== undefined){
                activeWindow.close();
            }
            activeWindow = infoWindow;
            infoWindow[i].open(map, marker);
      });
    }

</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCvlf0tCGkpE21Wxbi80hNfYo1vdNw3TOc&callback=initMap" async defer></script>